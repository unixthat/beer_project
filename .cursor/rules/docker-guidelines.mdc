---
description:
globs:
alwaysApply: false
---
# Docker Guidelines

## 1 Base Image
* Use `python:3.11-slim` as the starting point.
* Multi-arch build (`linux/amd64,linux/arm64`) via Buildx.

## 2 Layers
1. Copy `pyproject.toml`, `dev-requirements.txt`, `requirements.txt` first to leverage cache.
2. Install system build deps only when needed (e.g. `gcc`, `musl-dev`); remove after `pip install` to keep image small.
3. Copy source code *after* deps.

## 3 Entrypoints
* Server image label: `CMD ["python", "-m", "beer.server"]`.
* Client/bot images override with their own `CMD` in compose.

## 4 Non-root User
* Create `user beer` (`uid=1000`) and switch with `USER beer` for production safety.

## 5 Healthcheck
* Expose TCP port `5000` and add `HEALTHCHECK` with `curl --fail` to `/health` once implemented.

## 6 Caching & CI
* GitHub Actions: `docker buildx build --push --platform linux/amd64,linux/arm64 -t ghcr.io/org/beer:sha-${{ github.sha }}`.
* Use GitHub cachix or BuildKit inline cache for faster rebuilds.

Adhering to this rule ensures deterministic, minimal, and secure container images.
